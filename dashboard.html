<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Satrangi Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b6ba5;
      --bg2:#063f5e;
      --ink:#06202f;
      --card:#ffffff;
      --muted:#5f7483;
      --accent:#15a4ff;
      --safe:#28a745;
      --warn:#dc3545;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Roboto,system-ui,-apple-system,'Segoe UI',Poppins,Arial;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh}

    /* Layout */
    .layout{display:grid;grid-template-columns:280px 1fr 300px;min-height:100vh}
    .sidebar{background:rgba(255,255,255,0.96);border-right:1px solid #e6eef4;padding:18px 16px;position:sticky;top:0;height:100vh;overflow:auto}
    .safety-panel{background:rgba(255,255,255,0.96);border-left:1px solid #e6eef4;padding:18px 16px;position:sticky;top:0;height:100vh;overflow:auto}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--ink)}
    .brand svg{color:var(--accent)}
    .menu-title{margin:18px 0 8px 0;color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.08em}
    .navlink{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;color:var(--ink);text-decoration:none;font-weight:600}
    .navlink:hover{background:#eef6fc}

    .content{padding:20px}
    .topbar{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);backdrop-filter: blur(6px);padding:14px 16px;border-radius:14px;color:#fff}
    .top-actions{display:flex;gap:10px}
    .user-profile{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,0.15);padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.2)}
    .user-photo{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.3)}
    .user-info{display:flex;flex-direction:column}
    .user-name{font-weight:700;font-size:14px;margin:0}
    .user-dob{font-size:12px;opacity:0.8;margin:0}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#00263b}
    .btn.ghost{background:rgba(255,255,255,0.15);color:#fff;border:1px solid rgba(255,255,255,0.3)}

    /* Cards grid */
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:16px}
    .card{grid-column:span 6;background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,0.15);overflow:hidden;border:1px solid #e7eef5}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #eef3f8}
    .card-title{font-weight:800;color:var(--ink)}
    .card-body{padding:14px 16px;color:#19313f}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6fc;color:#084b6b;font-weight:700;font-size:12px}

    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .tile{border:1px solid #eef3f8;border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;background:#fff}
    .tile img{width:56px;height:56px;object-fit:cover;border-radius:10px}
    .tile .meta{display:flex;flex-direction:column}
    .meta .name{font-weight:700}
    .meta .sub{color:#6b7f8c;font-size:12px}

    /* Safety panel sections */
    .info{display:flex;flex-direction:column;gap:10px}
    .info .item{display:flex;gap:10px;padding:8px;border-radius:8px;background:#f8fafc;border:1px solid #eef3f8}
    .info .icon{width:24px;height:24px;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;background:#eef6fc;color:#0b6ba5;flex-shrink:0}
    .safe{color:var(--safe);font-weight:700}
    .danger{color:var(--warn);font-weight:700}
    
    /* Safety panel specific styles */
    .safety-section{margin-bottom:20px}
    .safety-section h3{margin:0 0 12px 0;font-size:14px;font-weight:700;color:var(--ink);text-transform:uppercase;letter-spacing:.5px}
    .red-zone-item{background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:10px;margin-bottom:8px}
    .red-zone-item .zone-name{font-weight:700;color:var(--warn);margin-bottom:4px}
    .red-zone-item .zone-desc{font-size:12px;color:#7f1d1d}
    .maps-btn{width:100%;background:var(--accent);color:#00263b;border:none;border-radius:10px;padding:12px;font-weight:700;cursor:pointer;margin-top:10px;transition:all 0.2s}
    .maps-btn:hover{background:#0d8ce8;transform:translateY(-1px)}
    .emergency-contact{background:#f0f9ff;border:1px solid #bae6fd;border-radius:8px;padding:10px;margin-bottom:8px}
    .emergency-contact .contact-name{font-weight:700;color:#0c4a6e;margin-bottom:2px}
    .emergency-contact .contact-number{font-size:12px;color:#075985}

    /* Responsive */
    @media (max-width: 1200px){
      .layout{grid-template-columns:280px 1fr}
      .safety-panel{display:none}
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);transition:transform .2s ease;z-index:30;width:280px}
      .sidebar.open{transform:none}
      .content{padding:16px}
      .card{grid-column:span 12}
      .hamburger{display:inline-flex}
    }
    .hamburger{display:none;gap:6px;flex-direction:column;cursor:pointer}
    .bar{width:22px;height:3px;background:#fff;border-radius:2px}

    /* Emergency Chatbot Styles */
    .emergency-chatbot{position:fixed;bottom:20px;right:20px;z-index:1000;width:350px;height:500px;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);border:1px solid #e6eef4;display:none;flex-direction:column;overflow:hidden}
    .chatbot-header{background:linear-gradient(135deg,var(--warn),#ff4757);color:#fff;padding:16px;display:flex;align-items:center;justify-content:space-between;font-weight:700}
    .chatbot-header .status{display:flex;align-items:center;gap:8px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#fff;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .chatbot-close{background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:4px}
    .chatbot-messages{flex:1;padding:16px;overflow-y:auto;background:#f8fafc}
    .message{margin-bottom:12px;display:flex;flex-direction:column}
    .message.user{align-items:flex-end}
    .message.bot{align-items:flex-start}
    .message-bubble{max-width:80%;padding:10px 14px;border-radius:12px;font-size:14px;line-height:1.4}
    .message.user .message-bubble{background:var(--accent);color:#fff}
    .message.bot .message-bubble{background:#fff;border:1px solid #e6eef4;color:var(--ink)}
    .message.emergency .message-bubble{background:var(--warn);color:#fff;font-weight:600;animation:emergencyPulse 1s infinite}
    @keyframes emergencyPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
    .message-time{font-size:11px;color:var(--muted);margin-top:4px}
    .chatbot-input{padding:16px;border-top:1px solid #e6eef4;background:#fff}
    .input-container{display:flex;gap:8px;align-items:center}
    .chat-input{flex:1;border:1px solid #e6eef4;border-radius:20px;padding:10px 16px;font-size:14px;outline:none}
    .chat-input:focus{border-color:var(--accent)}
    .voice-btn{background:var(--warn);border:none;border-radius:50%;width:40px;height:40px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
    .voice-btn:hover{background:#c82333;transform:scale(1.05)}
    .voice-btn.recording{background:#28a745;animation:recordingPulse 1s infinite}
    @keyframes recordingPulse{0%,100%{box-shadow:0 0 0 0 rgba(40,167,69,0.7)}50%{box-shadow:0 0 0 10px rgba(40,167,69,0)}}
    .send-btn{background:var(--accent);border:none;border-radius:50%;width:40px;height:40px;color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center}
    .send-btn:hover{background:#0d8ce8}
    .emergency-toggle{position:fixed;bottom:20px;right:20px;z-index:999;width:60px;height:60px;border-radius:50%;background:var(--warn);border:none;color:#fff;cursor:pointer;box-shadow:0 8px 25px rgba(220,53,69,0.4);display:flex;align-items:center;justify-content:center;font-size:24px;transition:all 0.3s}
    .emergency-toggle:hover{background:#c82333;transform:scale(1.1)}
    .emergency-toggle.active{background:var(--safe)}
    .location-status{background:rgba(40,167,69,0.1);border:1px solid rgba(40,167,69,0.3);border-radius:8px;padding:8px;margin:8px 0;font-size:12px;color:var(--safe);text-align:center}
    .danger-detected{background:rgba(220,53,69,0.1);border:1px solid rgba(220,53,69,0.3);border-radius:8px;padding:12px;margin:8px 0;color:var(--warn);font-weight:600;text-align:center;animation:dangerAlert 2s infinite}
    @keyframes dangerAlert{0%,100%{background:rgba(220,53,69,0.1)}50%{background:rgba(220,53,69,0.2)}}
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar" id="sidebar" aria-label="Safety & Info">
      <div class="brand" style="margin-bottom:10px">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2l8 4v6c0 5-3 9-8 10-5-1-8-5-8-10V6l8-4z"/></svg>
        <span>Satrangi Guide</span>
      </div>

      <div class="menu-title">Navigation</div>
      <a class="navlink" href="frontsheet.html">Home</a>
      <a class="navlink" href="after-login.html">Complete Profile</a>
      <a class="navlink" href="dashboard.html">Dashboard</a>
      <a class="navlink" href="authority.html" target="_blank" style="color:var(--warn)">üö® Authority Dashboard</a>
      <button class="navlink" style="width:100%;text-align:left;background:#f8fafc;border:1px solid #eef3f8" onclick="logout()">Logout</button>

    </aside>

    <main class="content">
      <div class="topbar">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="hamburger" id="hamburger" aria-label="Toggle menu" tabindex="0">
            <span class="bar"></span><span class="bar"></span><span class="bar"></span>
          </div>
          <div style="font-family:Poppins;font-weight:800;letter-spacing:.4px">Explore North-East Dashboard</div>
        </div>
        <div class="top-actions">
          <div class="user-profile" id="userProfile" style="display: none;">
            <img id="userPhoto" src="" alt="Profile" class="user-photo">
            <div class="user-info">
              <div class="user-name" id="userName"></div>
              <div class="user-dob" id="userDob"></div>
            </div>
          </div>
          <button class="btn ghost" onclick="window.location.href='frontsheet.html'">Home</button>
          <button class="btn primary" onclick="window.location.href='after-login.html'">Profile</button>
        </div>
      </div>

      <section class="grid" aria-label="Highlights">
        <article class="card" aria-labelledby="placesTitle">
          <div class="card-header">
            <div class="card-title" id="placesTitle">Beautiful Places</div>
            <span class="chip">Top picks</span>
          </div>
          <div class="card-body">
            <div class="list">
              <div class="tile"><img src="meghalaya.jpg" alt="Living Root Bridges"><div class="meta"><div class="name">Root Bridges</div><div class="sub">Meghalaya ‚Ä¢ Cherrapunji</div></div></div>
              <div class="tile"><img src="sikkim.jpg" alt="Tsomgo Lake"><div class="meta"><div class="name">Tsomgo Lake</div><div class="sub">Sikkim ‚Ä¢ Gangtok</div></div></div>
              <div class="tile"><img src="assam.jpg" alt="Kaziranga"><div class="meta"><div class="name">Kaziranga</div><div class="sub">Assam ‚Ä¢ Rhinos</div></div></div>
              <div class="tile"><img src="arunachal.jpg" onerror="this.src='river.jpg'" alt="Tawang"><div class="meta"><div class="name">Tawang</div><div class="sub">Arunachal ‚Ä¢ Monastery</div></div></div>
            </div>
          </div>
        </article>

        <article class="card" aria-labelledby="hotelsTitle">
          <div class="card-header">
            <div class="card-title" id="hotelsTitle">Hotels & Stays</div>
            <span class="chip">Comfort</span>
          </div>
          <div class="card-body">
            <div class="list">
              <div class="tile"><img src="travel.jpg" alt="Hotel Shillong"><div class="meta"><div class="name">Highland Inn</div><div class="sub">Shillong ‚Ä¢ 4.4‚òÖ</div></div></div>
              <div class="tile"><img src="sikkim1.jpg" alt="Resort Sikkim"><div class="meta"><div class="name">Himalayan View</div><div class="sub">Pelling ‚Ä¢ 4.6‚òÖ</div></div></div>
              <div class="tile"><img src="local.jpg" alt="Homestay"><div class="meta"><div class="name">Local Homestay</div><div class="sub">Kohima ‚Ä¢ 4.5‚òÖ</div></div></div>
            </div>
          </div>
        </article>

        <article class="card" aria-labelledby="foodTitle">
          <div class="card-header">
            <div class="card-title" id="foodTitle">Foods & Restaurants</div>
            <span class="chip">Taste</span>
          </div>
          <div class="card-body">
            <div class="list">
              <div class="tile"><img src="food.jpg" alt="Thukpa"><div class="meta"><div class="name">Thukpa</div><div class="sub">Sikkim ‚Ä¢ Hot noodle soup</div></div></div>
              <div class="tile"><img src="mizoram.jpg" alt="Bamboo shoot"><div class="meta"><div class="name">Bamboo Shoot</div><div class="sub">Mizo cuisine</div></div></div>
              <div class="tile"><img src="nagaland.jpg" alt="Smoked pork"><div class="meta"><div class="name">Smoked Pork</div><div class="sub">Naga specialty</div></div></div>
            </div>
          </div>
        </article>

        <article class="card" aria-labelledby="sportsTitle">
          <div class="card-header">
            <div class="card-title" id="sportsTitle">Sports & Adventure</div>
            <span class="chip">Action</span>
          </div>
          <div class="card-body">
            <div class="list">
              <div class="tile"><img src="trekking.jpg" alt="Trekking"><div class="meta"><div class="name">Trekking</div><div class="sub">Meghalaya & Sikkim</div></div></div>
              <div class="tile"><img src="river.jpg" alt="River rafting"><div class="meta"><div class="name">River Rafting</div><div class="sub">Teesta & Siang</div></div></div>
              <div class="tile"><img src="monsoon.jpg" alt="Caving"><div class="meta"><div class="name">Caving</div><div class="sub">Mawsmai & Krem Liat Prah</div></div></div>
            </div>
          </div>
        </article>

        <article class="card" aria-labelledby="festTitle">
          <div class="card-header">
            <div class="card-title" id="festTitle">Festivals & Culture</div>
            <span class="chip">Vibrant</span>
          </div>
          <div class="card-body">
            <div class="list">
              <div class="tile"><img src="dance.jpg" alt="Hornbill"><div class="meta"><div class="name">Hornbill Festival</div><div class="sub">Nagaland ‚Ä¢ December</div></div></div>
              <div class="tile"><img src="craft.jpg" alt="Ziro"><div class="meta"><div class="name">Ziro Festival</div><div class="sub">Arunachal ‚Ä¢ Music</div></div></div>
              <div class="tile"><img src="ap.jpg" alt="Bihu"><div class="meta"><div class="name">Bihu</div><div class="sub">Assam ‚Ä¢ Harvest</div></div></div>
            </div>
          </div>
        </article>

        <article class="card" aria-labelledby="hiddenTitle">
          <div class="card-header">
            <div class="card-title" id="hiddenTitle">Hidden Spots</div>
            <span class="chip">Offbeat</span>
          </div>
          <div class="card-body">
            <div class="list">
              <div class="tile"><img src="tripura.jpg" alt="Unakoti"><div class="meta"><div class="name">Unakoti</div><div class="sub">Tripura ‚Ä¢ Rock reliefs</div></div></div>
              <div class="tile"><img src="manipur.jpg" alt="Loktak"><div class="meta"><div class="name">Phumdis of Loktak</div><div class="sub">Manipur ‚Ä¢ Floating islands</div></div></div>
              <div class="tile"><img src="mizoram.jpg" alt="Vantawng"><div class="meta"><div class="name">Vantawng Falls</div><div class="sub">Mizoram ‚Ä¢ Cascades</div></div></div>
            </div>
          </div>
        </article>
      </section>
    </main>

    <aside class="safety-panel" aria-label="Safety & Emergency Info">
      <div class="brand" style="margin-bottom:15px">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2l8 4v6c0 5-3 9-8 10-5-1-8-5-8-10V6l8-4z"/></svg>
        <span>Safety Hub</span>
      </div>

      <div class="safety-section">
        <h3>üö® Red Zones & Restricted Areas</h3>
        <div class="red-zone-item">
          <div class="zone-name">Border Areas</div>
          <div class="zone-desc">Arunachal Pradesh, Mizoram borders - Requires permits</div>
        </div>
        <div class="red-zone-item">
          <div class="zone-name">Militant Areas</div>
          <div class="zone-desc">Parts of Manipur, Nagaland - Avoid after dark</div>
        </div>
        <div class="red-zone-item">
          <div class="zone-name">Restricted Monuments</div>
          <div class="zone-desc">Some archaeological sites require special permission</div>
        </div>
      </div>

      <div class="safety-section">
        <h3>üìû Emergency Contacts</h3>
        <div class="emergency-contact">
          <div class="contact-name">All India Emergency</div>
          <div class="contact-number">112</div>
        </div>
        <div class="emergency-contact">
          <div class="contact-name">Ambulance</div>
          <div class="contact-number">108</div>
        </div>
        <div class="emergency-contact">
          <div class="contact-name">Tourist Helpline</div>
          <div class="contact-number">1800-11-1363</div>
        </div>
        <div class="emergency-contact">
          <div class="contact-name">Police Control</div>
          <div class="contact-number">100</div>
        </div>
      </div>

      <div class="safety-section">
        <h3>üéØ Tourist Behavior Guidelines</h3>
        <div class="info">
          <div class="item">
            <span class="icon">üì∏</span>
            <div>
              <div class="name">Photography</div>
              <div class="sub">Ask permission before taking photos of locals</div>
            </div>
          </div>
          <div class="item">
            <span class="icon">üëó</span>
            <div>
              <div class="name">Dress Code</div>
              <div class="sub">Dress modestly in villages and religious sites</div>
            </div>
          </div>
          <div class="item">
            <span class="icon">ü§ù</span>
            <div>
              <div class="name">Respect</div>
              <div class="sub">Respect local customs and traditions</div>
            </div>
          </div>
          <div class="item">
            <span class="icon">üåø</span>
            <div>
              <div class="name">Environment</div>
              <div class="sub">Don't litter, especially in protected areas</div>
            </div>
          </div>
        </div>
      </div>

      <div class="safety-section">
        <h3>üè• Health & Safety</h3>
        <div class="info">
          <div class="item">
            <span class="icon">üíä</span>
            <div>
              <div class="name">Medical Kit</div>
              <div class="sub">Carry basic medicines and first aid</div>
            </div>
          </div>
          <div class="item">
            <span class="icon">üíß</span>
            <div>
              <div class="name">Water Safety</div>
              <div class="sub">Drink bottled or boiled water only</div>
            </div>
          </div>
          <div class="item">
            <span class="icon">ü¶ü</span>
            <div>
              <div class="name">Mosquito Protection</div>
              <div class="sub">Use repellent, especially in forest areas</div>
            </div>
          </div>
          <div class="item">
            <span class="icon">üì±</span>
            <div>
              <div class="name">Communication</div>
              <div class="sub">Keep phone charged, share location with family</div>
            </div>
          </div>
        </div>
      </div>

      <div class="safety-section">
        <h3>üó∫Ô∏è Interactive Maps</h3>
        <button class="maps-btn" onclick="openMaps()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right:8px;vertical-align:middle">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
          </svg>
          View Safety Map
        </button>
        <div style="font-size:12px;color:var(--muted);margin-top:8px;text-align:center">
          Shows red zones, restaurants, attractions & emergency services
        </div>
      </div>
    </aside>
  </div>

  <!-- Emergency Chatbot Toggle Button -->
  <button class="emergency-toggle" id="emergencyToggle" onclick="toggleEmergencyChat()" title="Emergency Assistant">
    üö®
  </button>

  <!-- Emergency Chatbot Widget -->
  <div class="emergency-chatbot" id="emergencyChat">
    <div class="chatbot-header">
      <div class="status">
        <span class="status-dot"></span>
        <span>Emergency Assistant</span>
      </div>
      <button class="chatbot-close" onclick="toggleEmergencyChat()">√ó</button>
    </div>
    
    <div class="chatbot-messages" id="chatMessages">
      <div class="location-status" id="locationStatus">
        üìç Getting your location...
      </div>
      <div class="message bot">
        <div class="message-bubble">
          Hello! I'm your emergency assistant. I can help you with:
          <br>‚Ä¢ Emergency alerts and SOS
          <br>‚Ä¢ Safety information
          <br>‚Ä¢ Location sharing
          <br>‚Ä¢ Voice commands
          <br><br>
          <strong>Say "HELP", "EMERGENCY", or "SOS" if you're in danger!</strong>
        </div>
        <div class="message-time" id="welcomeTime"></div>
      </div>
    </div>
    
    <div class="chatbot-input">
      <div class="input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message or use voice..." onkeypress="handleKeyPress(event)">
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="Voice Input">
          üé§
        </button>
        <button class="send-btn" onclick="sendMessage()" title="Send Message">
          ‚û§
        </button>
      </div>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById('sidebar');
    const hamburger = document.getElementById('hamburger');
  
    function toggleSidebar(){ sidebar.classList.toggle('open'); }
    if (hamburger){
      hamburger.addEventListener('click', toggleSidebar);
      hamburger.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleSidebar(); }});
    }
  
    function logout(){
      localStorage.removeItem('user');
      localStorage.removeItem('isLoggedIn');
      window.location.href='frontsheet.html';
    }
  
    function openMaps(){
      window.location.href='geofence.html';
    }
  
    // Load user profile
    async function loadUserProfile() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const userProfile = document.getElementById('userProfile');
      const userPhoto = document.getElementById('userPhoto');
      const userName = document.getElementById('userName');
      const userDob = document.getElementById('userDob');
  
      if(user.username){
        userName.textContent=user.username;
        userDob.textContent=`Email: ${user.email}`;
        userPhoto.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iMjAiIGZpbGw9IiNmMGY4ZmYiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iIzAwNzNlNiI+CjxwYXRoIGQ9Ik0xMiAxMmMyLjIxIDAgNC0xLjc5IDQtNHMtMS43OS00LTQtNC00IDEuNzktNCA0IDEuNzkgNCA0IDR6bTAgMmMtMi42NyAwLTggMS4zNC04IDR2MmgxNnYtMmMwLTIuNjYtNS4zMy00LTgtNHoiLz4KPC9zdmc+Cjwvc3ZnPg==';
        userProfile.style.display='flex';
      }
    }
    window.addEventListener('load', loadUserProfile);
  
    // ----------------- Emergency Chatbot -----------------
    const chat = document.getElementById('emergencyChat');
    const toggleBtn = document.getElementById('emergencyToggle');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const voiceBtn = document.getElementById('voiceBtn');
    let recognition=null;
    let isRecording=false;
    let currentLocation=null;
    const emergencyKeywords=['help','emergency','sos','danger','attack','fire','accident','injured','lost','trapped','robbery','assault'];
  
    function toggleEmergencyChat(){
      if(chat.style.display==='flex'){
        chat.style.display='none';
        toggleBtn.classList.remove('active');
        toggleBtn.textContent='üö®';
      }else{
        chat.style.display='flex';
        toggleBtn.classList.add('active');
        toggleBtn.textContent='‚úì';
      }
    }
  
    function addMessage(msg, sender='bot', emergency=false){
      const msgDiv=document.createElement('div');
      msgDiv.className=`message ${sender}${emergency?' emergency':''}`;
      const bubble=document.createElement('div');
      bubble.className='message-bubble';
      bubble.innerHTML=msg;
      const time=document.createElement('div');
      time.className='message-time';
      time.textContent=new Date().toLocaleTimeString();
      msgDiv.appendChild(bubble);
      msgDiv.appendChild(time);
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop=chatMessages.scrollHeight;
    }
  
    function sendMessage(){
      const msg=chatInput.value.trim();
      if(!msg) return;
      addMessage(msg,'user');
      processMessage(msg);
      chatInput.value='';
    }
  
    function handleKeyPress(e){
      if(e.key==='Enter') sendMessage();
    }
  
    function toggleVoiceRecording(){
      if(!recognition){ addMessage('‚ùå Voice recognition not supported.'); return; }
      if(isRecording) recognition.stop(); else recognition.start();
    }
  
    function initSpeechRecognition(){
      if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) { voiceBtn.style.display='none'; return; }
      recognition=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
      recognition.continuous=false;
      recognition.interimResults=false;
      recognition.lang='en-US';
      recognition.onstart=()=>{isRecording=true;voiceBtn.classList.add('recording'); addMessage('üé§ Listening...','bot');};
      recognition.onresult=e=>{
        const transcript=e.results[0][0].transcript;
        chatInput.value=transcript;
        addMessage(transcript,'user',true);
        processMessage(transcript);
      };
      recognition.onerror=e=>{ addMessage('‚ùå Voice recognition error.'); };
      recognition.onend=()=>{isRecording=false;voiceBtn.classList.remove('recording');};
    }
  
    function processMessage(message){
      const lower=message.toLowerCase();
      const isEmergency=emergencyKeywords.some(k=>lower.includes(k));
      if(isEmergency) handleEmergency(message);
      else handleQuery(lower);
    }
  
    function handleEmergency(msg){
      addMessage('üö® <strong>EMERGENCY DETECTED!</strong> Authorities notified.<br>üìç Location: '+(currentLocation?`${currentLocation.lat.toFixed(4)}, ${currentLocation.lng.toFixed(4)}`:'Getting location...'),'bot',true);
      addMessage('üìû Emergency contacts:<br>‚Ä¢ All India Emergency: 112<br>‚Ä¢ Police: 100<br>‚Ä¢ Ambulance: 108<br>‚Ä¢ Tourist Helpline: 1800-11-1363','bot');
      showDangerAlert();
      sendEmergencyAlert(msg);
    }
  
    function showDangerAlert(){
      const alertDiv=document.createElement('div');
      alertDiv.className='danger-detected';
      alertDiv.innerHTML='‚ö†Ô∏è <strong>DANGER DETECTED</strong><br>Authorities alerted!';
      chatMessages.appendChild(alertDiv);
      chatMessages.scrollTop=chatMessages.scrollHeight;
    }
  
    function handleQuery(msg){
      if(msg.includes('location')){
        if(currentLocation){
          addMessage(`üìç Your current location:<br>Latitude: ${currentLocation.lat.toFixed(6)}<br>Longitude: ${currentLocation.lng.toFixed(6)}<br><a href="https://maps.google.com/?q=${currentLocation.lat},${currentLocation.lng}" target="_blank">View on Google Maps</a>`);
        } else addMessage('üìç Getting your location...');
      } else if(msg.includes('safety')||msg.includes('tips')){
        addMessage('üõ°Ô∏è Safety Tips:<br>‚Ä¢ Share location<br>‚Ä¢ Stay in well-lit areas<br>‚Ä¢ Keep contacts handy<br>‚Ä¢ Trust instincts<br>‚Ä¢ Avoid isolated areas at night');
      } else if(msg.includes('contact')||msg.includes('number')){
        addMessage('üìû Emergency Contacts:<br>‚Ä¢ All India Emergency: 112<br>‚Ä¢ Police: 100<br>‚Ä¢ Ambulance: 108<br>‚Ä¢ Tourist Helpline: 1800-11-1363');
      } else addMessage('I can help with location, safety tips, or emergency alerts. Say "HELP", "SOS", or "EMERGENCY" if in danger!');
    }
  
    function startLocationTracking(){
      if(!('geolocation' in navigator)) { 
        document.getElementById('locationStatus').textContent='üìç Location not supported.'; 
        return; 
      }
      navigator.geolocation.getCurrentPosition(pos=>{
        currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy};
        document.getElementById('locationStatus').textContent=`üìç Location active (¬±${Math.round(currentLocation.accuracy)}m)`;
      },err=>{
        document.getElementById('locationStatus').textContent='üìç Location access denied.';
      },{enableHighAccuracy:true});
  
      navigator.geolocation.watchPosition(pos=>{
        currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude,accuracy:pos.coords.accuracy};
      },err=>{console.log('Location error:',err);},{enableHighAccuracy:true,maximumAge:30000,timeout:10000});
    }
  
    async function sendEmergencyAlert(msg){
      try{
        const user=JSON.parse(localStorage.getItem('user')||'{}');
        const alertData={
          touristId:user.id,
          touristName:user.username,
          blockchainId:user.blockchainId,
          message:msg,
          location:currentLocation,
          timestamp:new Date().toISOString(),
          type:'emergency',
          status:'active'
        };
        await fetch('http://localhost:3000/api/emergency-alert',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(alertData)
        });
      }catch(e){console.error('Emergency alert failed:',e);}
    }
  
    window.addEventListener('load',()=>{
      initSpeechRecognition();
      startLocationTracking();
    });
  </script>
  
</body>
</html>

